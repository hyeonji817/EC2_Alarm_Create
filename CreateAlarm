import boto3
import json

# (local용)
#session = boto3.Session(
#    aws_access_key_id="계정 Access Key",
#    aws_secret_access_key="계정 Secret Key",
#    region_name=SUPPORT_REGION,  # 세션의 기본 리전도 맞춰둠
# )
# ec2 = session.client('ec2')  # ec2 객체 생성
# cloudwatch = session.client('cloudwatch')  # cloudwatch 객체 생성

# (aws lambda용)
ec2 = boto3.client('ec2')  # ec2 객체 생성
cloudwatch = boto3.client('cloudwatch')  # cloudwatch 객체 생성


def lambda_handler(event, context):  # event와, context는 각각 이벤트가 발생하면 aws에서 넣어주는 데이터와, 내부 구성 객체르 의미
    print("event 문규 테스트")  # 차후 삭제
    print("Received event:", event)
    print("event 문규 테스트")  # 차후 삭제

    #### 이벤트가 EC2 인스턴스 생성 이벤트인지 판별 (event 딕셔너리의 detail 키에 대해, eventName 키에 대한 값이 RunInstances와 일치한지 유무)
    if event.get('detail', {}).get('eventName') != 'RunInstances':  # RunInstances 이벤트가 아니면 종료
        print("Not an EC2 RunInstances event.")
        print(json.dumps(event, indent=2))
        return

    instances = event['detail']['responseElements']['instancesSet']['items']  # 생성된 인스턴스 목록 리스트 추출
    for instance in instances:  # 인스턴스 각각에 대해 순회
        instance_id = instance['instanceId']
        instance_name = instance['instanceName']

        # [추가] Auto Scaling Group 이름이 'asg-smk3'인지 확인
        # EC2 인스턴스에 할당된 태그 중 'aws:autoscaling:groupName' 키의 값을 확인
        asg_tags_response = ec2.describe_tags(
            Filters=[
                {'Name': 'resource-id', 'Values': [instance_id]},  # 인스턴스 ID로 태그 조회
                {'Name': 'key', 'Values': ['aws:autoscaling:groupName']}  # Auto Scaling Group 태그 필터
            ]
        )
        asg_tags = asg_tags_response.get('Tags', [])  # 반환값에서 태그 목록 추출
        asg_tag = next(
            (tag for tag in asg_tags if tag['Key'] == 'aws:autoscaling:groupName' and tag['Value'] == 'asg-smk3'),
            None
        )
        if not asg_tag:  # asg-smk3에 속하지 않은 경우 건너뜀
            print(f"Instance {instance_id} is not part of asg-smk3. Skipping.")
            continue

        # Get tags for the instance (Alarm=Y)
        tags_response = ec2.describe_tags(  # EC2 태그 값 수집
            Filters=[
                {'Name': 'resource-id', 'Values': [instance_id]},
                {'Name': 'key', 'Values': ['Alarm']}
            ]
        )
        print("tag_response 문규 테스트")  # 차후 삭제
        print(tags_response)
        print("tag_response 문규 테스트")  # 차후 삭제

        tags = tags_response.get('Tags', [])  # 수집된 태그 리스트 저장

        alarm_tag = next((tag for tag in tags if tag['Key'] == 'Alarm' and tag['Value'] == 'Y'), None)

        print("tag_response 문규 테스트")  # 차후 삭제
        print(alarm_tag)
        print("tag_response 문규 테스트")  # 차후 삭제

        if not alarm_tag:
            print(f"No Alarm=Y tag found for instance {instance_id}")
            continue

        print(f"Creating alarms for instance {instance_id}")

        # 위 변수를 근거로 create_alarm 수행
        create_alarm(instance_name, instance_id, 'CPUUtilization', 'AWS/EC2', 'Percent', 50.0, 'Average')
        create_alarm(instance_name, instance_id, 'StatusCheckFailed', 'AWS/EC2', 'Count', 1.0, 'Maximum')
        create_alarm(instance_name, instance_id, 'mem_used_percent', 'CWAgent', 'Percent', 50.0, 'Average')
        create_alarm(instance_name, instance_id, 'disk_used_percent', 'CWAgent', 'Percent', 50.0, 'Average')


def create_alarm(instance_name, instance_id, metric_name, namespace, unit, threshold, statistic):
    alarm_name = f'{instance_name}-{instance_id}-{metric_name}'

    existing = cloudwatch.describe_alarms(AlarmNames=[alarm_name])  # 이미 존재하는 alarm인지 확인
    if existing['MetricAlarms']:
        print(f"Alarm {alarm_name} already exists.")
        return

    cloudwatch.put_metric_alarm(  # 새 CloudWatch 알람 생성
        AlarmName=alarm_name,
        ComparisonOperator='GreaterThanThreshold',
        EvaluationPeriods=2,
        MetricName=metric_name,
        Namespace=namespace,
        Period=300,
        Statistic=statistic,
        Threshold=threshold,
        ActionsEnabled=False,
        AlarmDescription=f'{metric_name} alarm for {instance_id}',
        Dimensions=[
            {'Name': 'InstanceId', 'Value': instance_id}
        ],
        Unit=unit
    )
    print(f"Created alarm: {alarm_name}")
